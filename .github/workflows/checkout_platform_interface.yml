name: "Checkout platform interface"


on:
  workflow_call:


jobs:
  checkout:
    name: "Checkout"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./flutter_badge_manager_platform_interface/
    env:
      pub-cache-name: pub
      threshold: 50
    timeout-minutes: 15
    steps:
      - name: ðŸš‚ Get latest code
        id: checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github
            pubspec.yaml
            lib
            test
            analysis_options.yaml
            CHANGELOG.md

      - name: ðŸ‘· Install flutter
        uses: subosito/flutter-action@v2
        id: install-flutter
        with:
          channel: 'stable'

      - name: ðŸ”Ž Check flutter version
        id: check-flutter-version
        run: flutter --version

      - name: ðŸ“¤ Restore Pub modules
        id: cache-pub-restore
        uses: actions/cache/restore@v4
        with:
          path: |
            $PWD/.pub_cache/
          key: ${{ runner.os }}-pub-${{ env.pub-cache-name }}-${{ hashFiles('**/pubspec.yaml') }}

      - name: ðŸ—„ï¸ Export Pub cache directory
        id: export-pub-cache
        timeout-minutes: 1
        run: |
          export PUB_CACHE=$PWD/.pub_cache/
          export PATH="$PATH":"$HOME/.pub-cache/bin"
          echo "${HOME}/.pub-cache/bin" >> $GITHUB_PATH

      - name: ðŸ‘· Install Dependencies
        id: install-dependencies
        timeout-minutes: 2
        run: |
          apt-get update && apt-get install -y lcov
          flutter pub get --no-example

      - name: ðŸ“¥ Save Pub modules
        id: cache-pub-save
        uses: actions/cache/save@v4
        with:
          path: |
            $PWD/.pub_cache/
          key: ${{ runner.os }}-pub-${{ env.pub-cache-name }}-${{ hashFiles('**/pubspec.yaml') }}

      - name: ðŸ”Ž Check content
        id: check_files
        uses: andstor/file-existence-action@v1
        with:
          files: "README.md, CHANGELOG.md, LICENSE"

      - name: â” File exists
        if: steps.check_files.outputs.files_exists == 'true'
        run: echo Content is ok!

      - name: ðŸ”Ž Check description
        run: echo | grep -q Description README.md ; echo $?

      - name: ðŸ‘· Install dependencies
        run: flutter pub get

      - name: ðŸ§ª Run dependency validator
        run: |
          dart pub global activate dependency_validator
          dart pub global run dependency_validator:dependency_validator

      - name: ðŸ”Ž Check format
        id: check_format
        run: dart format --set-exit-if-changed -l 80 -o none lib/

      - name: ðŸ“ˆ Check analyzer
        id: check_analyzer
        run: dart analyze --fatal-warnings --no-fatal-infos lib/ test/

  testing:
      name: "Testing"
      runs-on: ubuntu-latest
      defaults:
        run:
          working-directory: ./flutter_badge_manager_platform_interface/
      env:
        pub-cache-name: pub
        threshold: 50
      timeout-minutes: 15
      steps:
        - name: ðŸš‚ Get latest code
          id: checkout
          uses: actions/checkout@v4
          with:
            sparse-checkout: |
              .github
              pubspec.yaml
              lib
              test
              analysis_options.yaml
              CHANGELOG.md

        - name: ðŸ‘· Install flutter
          uses: subosito/flutter-action@v2
          id: install-flutter
          with:
            channel: 'stable'

        - name: ðŸ”Ž Check flutter version
          id: check-flutter-version
          run: flutter --version

        - name: ðŸ“¤ Restore Pub modules
          id: cache-pub-restore
          uses: actions/cache/restore@v4
          with:
            path: |
              $PWD/.pub_cache/
            key: ${{ runner.os }}-pub-${{ env.pub-cache-name }}-${{ hashFiles('**/pubspec.yaml') }}

        - name: ðŸ—„ï¸ Export Pub cache directory
          id: export-pub-cache
          timeout-minutes: 1
          run: |
            export PUB_CACHE=$PWD/.pub_cache/
            export PATH="$PATH":"$HOME/.pub-cache/bin"
            echo "${HOME}/.pub-cache/bin" >> $GITHUB_PATH

        - name: ðŸ‘· Install Dependencies
          id: install-dependencies
          timeout-minutes: 2
          run: |
            apt-get update && apt-get install -y lcov
            flutter pub get --no-example

        - name: ðŸ“¥ Save Pub modules
          id: cache-pub-save
          uses: actions/cache/save@v4
          with:
            path: |
              $PWD/.pub_cache/
            key: ${{ runner.os }}-pub-${{ env.pub-cache-name }}-${{ hashFiles('**/pubspec.yaml') }}

        - name: ðŸ§ª Run tests
          timeout-minutes: 2
          env:
            CODECOV_TOKEN: ${{secrets.CODECOV_TOKEN}}
          if: success()
          run: |
            flutter test --coverage
            bash <(curl -s https://codecov.io/bash) -f coverage/lcov.info